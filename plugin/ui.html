<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: -apple-system, sans-serif; margin: 0; padding: 20px; }
        .view { display: none; }
        .view.active { display: flex; flex-direction: column; gap: 15px; }
        button { background-color: #1a1a1a; color: white; padding: 10px 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; }
        button:disabled { background-color: #cccccc; }
        textarea { width: 100%; height: 80px; padding: 10px; box-sizing: border-box; border: 1px solid #e0e0e0; border-radius: 8px; }
        input[type="text"] { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #e0e0e0; border-radius: 8px; }
        .tags { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag { background-color: #f0f0f0; padding: 6px 12px; border-radius: 16px; font-size: 14px; cursor: pointer; }
        p { margin: 0; color: #555; }
        .moodboard-header { display: flex; justify-content: space-between; align-items: center; }
        .moodboard-header h3 { margin: 0; text-transform: capitalize; }
        .back-button { background: none; border: none; cursor: pointer; font-size: 24px; padding: 0; }
        .moodboard-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-height: 600px; overflow-y: auto; padding: 5px; }
        .pin-container { position: relative; }
        .pin-image { width: 100%; height: 150px; object-fit: cover; background-color: #f0f0f0; border-radius: 8px; }
        
        /* --- NUEVOS ESTILOS --- */
        .pin-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); border-radius: 8px; display: flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.2s; cursor: pointer; }
        .pin-container:hover .pin-overlay { opacity: 1; }
        .overlay-button { background: none; border: none; color: white; cursor: pointer; padding: 5px; }
        .delete-button { position: absolute; top: 4px; right: 4px; background-color: rgba(0,0,0,0.5); color: white; border-radius: 50%; width: 20px; height: 20px; line-height: 20px; text-align: center; }
        
        .lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); display: none; justify-content: center; z-index: 1000; overflow-y: auto; align-items: flex-start; padding: 5vh 0; box-sizing: border-box; }
        .lightbox.active { display: flex; }
        .lightbox-content { max-width: 90%; object-fit: contain; }
        .lightbox-close { position: fixed; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; }

        .lightbox-actions { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.5); padding: 8px; border-radius: 8px; }
        #lightboxDeleteButton { background-color: #dc3545; }

        .lightbox-nav { position: fixed; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; line-height: 40px; text-align: center; cursor: pointer; }
        .lightbox-nav.prev { left: 20px; }
        .lightbox-nav.next { right: 20px; }

        /* --- AÑADIR ESTO AL FINAL DE TU CSS --- */
        .pin-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); border-radius: 8px; display: flex; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.2s; cursor: pointer; }
        .pin-container:hover .pin-overlay { opacity: 1; }
        .overlay-button { background: none; border: none; color: white; cursor: pointer; padding: 5px; }
        .delete-button { position: absolute; top: 4px; right: 4px; background-color: rgba(0,0,0,0.5); color: white; border-radius: 50%; width: 20px; height: 20px; line-height: 20px; text-align: center; }

        .lightbox { overflow-y: auto; align-items: flex-start; padding: 5vh 0; box-sizing: border-box; }
        .lightbox-content { max-width: 90%; }
        .lightbox-close { position: fixed; }
        .lightbox-actions { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.5); padding: 8px; border-radius: 8px; }
        .lightbox-nav { position: fixed; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; line-height: 40px; text-align: center; cursor: pointer; }
        .lightbox-nav.prev { left: 20px; }
        .lightbox-nav.next { right: 20px; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; text-align: center; max-width: 280px; }
        .modal-secondary-text { font-size: 13px; color: #777; margin: 5px 0 15px 0; }
        .modal-buttons { display: flex; gap: 10px; justify-content: center; }

        .spinner-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1500; }
        .spinner-overlay.active { display: flex; }
        .spinner { border: 4px solid rgba(255,255,255,0.2); border-left-color: #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .toast { position: fixed; bottom: -50px; left: 50%; transform: translateX(-50%); background-color: #28a745; color: white; padding: 10px 20px; border-radius: 8px; z-index: 3000; transition: bottom 0.5s ease-in-out; }
        .toast.show { bottom: 30px; }
    </style>
</head>
<body>

    <!-- Vista de Autenticación -->
    <div id="view-auth" class="view">
        <p>1. Haz clic para obtener tu token de Pinterest.</p>
        <button id="connectButton">Conectar con Pinterest</button>
        <div id="auth-step-2" style="display: none; flex-direction: column; gap: 15px;">
            <p>2. Pega el token aquí y confirma.</p>
            <textarea id="tokenInput" placeholder="Pega el token que copiaste..."></textarea>
            <button id="confirmButton">Confirmar Conexión</button>
        </div>
    </div>
    
    <!-- Vista de Búsqueda -->
    <div id="view-search" class="view">
        <input type="text" id="searchInput" placeholder="What type of inspiration you need?">
        <button id="createMoodboardButton">Create Moodboard</button>
        <p>Popular:</p>
        <div class="tags">
            <div class="tag" data-category="landing">landing</div>
            <div class="tag" data-category="dashboard">dashboard</div>
            <div class="tag" data-category="typography">typography</div>
            <div class="tag" data-category="mobile-app">mobile app</div>
        </div>
    </div>

    <!-- Vista de Moodboard -->
    <div id="view-moodboard" class="view">
        <div class="moodboard-header">
            <button id="backButton" class="back-button">←</button>
            <h3 id="moodboardTitle"></h3>
            <button id="getStyleGuideButton">Get the style guide</button>
        </div>
        <div id="moodboardGrid" class="moodboard-grid"></div>
    </div>

    <!-- HTML para el Lightbox -->
    <div id="lightbox" class="lightbox">
        <span id="lightboxClose" class="lightbox-close">&times;</span>
        <button id="lightboxPrev" class="lightbox-nav prev">&lt;</button>
        <img id="lightboxImage" class="lightbox-content">
        <button id="lightboxNext" class="lightbox-nav next">&gt;</button>
        <div class="lightbox-actions">
            <button id="lightboxDeleteButton">Eliminar</button>
        </div>
    </div>

    <!-- --- AÑADIR ESTO ANTES DE </body> --- -->
<div id="lightbox" class="lightbox">
    <div id="spinnerOverlay" class="spinner-overlay">
        <div class="spinner"></div>
    </div>
    <span id="lightboxClose" class="lightbox-close">&times;</span>
    <button id="lightboxPrev" class="lightbox-nav prev">&lt;</button>
    <img id="lightboxImage" class="lightbox-content">
    <button id="lightboxNext" class="lightbox-nav next">&gt;</button>
    <div class="lightbox-actions">
        <button id="lightboxDeleteButton" class="danger">Eliminar</button>
    </div>
</div>
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <p><strong>¿Quitar esta imagen del moodboard?</strong></p>
        <p class="modal-secondary-text">Esta acción no se puede deshacer.</p>
        <div class="modal-buttons">
            <button id="cancelDeleteButton" class="secondary">Cancelar</button>
            <button id="confirmDeleteButton" class="danger">Quitar</button>
        </div>
    </div>
</div>
<div id="toast" class="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const views = { auth: document.getElementById('view-auth'), search: document.getElementById('view-search'), moodboard: document.getElementById('view-moodboard') };
            function showView(viewId) { Object.values(views).forEach(v => v.classList.remove('active')); if (views[viewId]) views[viewId].classList.add('active'); }
            function startSearch(category) { if (!category || category.trim() === '') return; const normalizedCategory = category.toLowerCase().trim(); showView('moodboard'); document.getElementById('moodboardTitle').textContent = 'Cargando...'; document.getElementById('moodboardGrid').innerHTML = '<p>Buscando inspiración...</p>'; parent.postMessage({ pluginMessage: { type: 'get-pins', category: normalizedCategory } }, '*'); }
            
            let currentImageUrls = [];
            let currentImageIndex = -1;
            
            const lightbox = document.getElementById('lightbox');
            const lightboxImage = document.getElementById('lightboxImage');
            const lightboxClose = document.getElementById('lightboxClose');
            const lightboxPrev = document.getElementById('lightboxPrev');
            const lightboxNext = document.getElementById('lightboxNext');
            const lightboxDeleteButton = document.getElementById('lightboxDeleteButton');
            const confirmModal = document.getElementById('confirmModal');
            const cancelDeleteButton = document.getElementById('cancelDeleteButton');
            const confirmDeleteButton = document.getElementById('confirmDeleteButton');
            const spinnerOverlay = document.getElementById('spinnerOverlay');
            const toast = document.getElementById('toast');

            window.onmessage = (event) => {
                if (event.data.pluginMessage) {
                    const { type, view, url, data, imageBytes, target } = event.data.pluginMessage;
                    if (type === 'show-view') {
                        showView(view);
                        if (view === 'moodboard' && data) {
                            currentImageUrls = [];
                            const grid = document.getElementById('moodboardGrid');
                            const title = document.getElementById('moodboardTitle');
                            grid.innerHTML = '';
                            title.textContent = data.category;
                            if (data.pins && data.pins.length > 0) {
                                data.pins.forEach(pin => {
                                    if (!pin.thumbnailUrl || !pin.fullsizeUrl) return;
                                    currentImageUrls.push(pin.fullsizeUrl);
                                    const container = document.createElement('div');
                                    container.className = 'pin-container';
                                    container.dataset.fullsizeUrl = pin.fullsizeUrl;
                                    const img = document.createElement('img');
                                    img.className = 'pin-image';
                                    img.dataset.thumbnailUrl = pin.thumbnailUrl;
                                    const overlay = document.createElement('div');
                                    overlay.className = 'pin-overlay';
                                    overlay.innerHTML = `<button class="overlay-button view-button" title="View larger"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 12C15 13.6569 13.6569 15 12 15C10.3431 15 9 13.6569 9 12C9 10.3431 10.3431 9 12 9C13.6569 9 15 10.3431 15 12Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 12C3.60014 7.90264 7.33603 5 12 5C16.664 5 20.3999 7.90264 22 12C20.3999 16.0974 16.664 19 12 19C7.33603 19 3.60014 16.0974 2 12Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>`;
                                    overlay.onclick = () => showLightbox(pin.fullsizeUrl);
                                    const deleteBtn = document.createElement('button');
                                    deleteBtn.className = 'delete-button overlay-button';
                                    deleteBtn.innerHTML = '&times;';
                                    deleteBtn.onclick = (e) => { e.stopPropagation(); container.remove(); };
                                    container.appendChild(img);
                                    overlay.appendChild(deleteBtn);
                                    container.appendChild(overlay);
                                    grid.appendChild(container);
                                    parent.postMessage({ pluginMessage: { type: 'fetch-image', url: pin.thumbnailUrl, target: 'grid' } }, '*');
                                });
                            } else { grid.innerHTML = '<p>No se encontraron pines.</p>'; }
                        }
                    } else if (type === 'open-auth-window') { window.open(url); } else if (type === 'image-loaded') {
                        const blob = new Blob([imageBytes]);
                        const objectUrl = URL.createObjectURL(blob);
                        if (target === 'lightbox') {
                            lightboxImage.src = objectUrl;
                        } else {
                            const imgElement = document.querySelector(`img[data-thumbnail-url="${url}"]`);
                            if (imgElement) { imgElement.src = objectUrl; }
                        }
                    }
                }
            };
            
            function showLightbox(fullsizeUrl) { currentImageIndex = currentImageUrls.indexOf(fullsizeUrl); updateLightboxImage(); lightbox.classList.add('active'); }
            function updateLightboxImage() { if (currentImageIndex < 0 || currentImageIndex >= currentImageUrls.length) return; const url = currentImageUrls[currentImageIndex]; lightboxImage.src = ''; parent.postMessage({ pluginMessage: { type: 'fetch-image', url: url, target: 'lightbox' } }, '*'); }
            function closeLightbox() { lightbox.classList.remove('active'); lightboxImage.src = ''; currentImageIndex = -1; }
            function showToast(message) { toast.textContent = message; toast.classList.add('show'); setTimeout(() => { toast.classList.remove('show'); }, 2500); }

            lightboxClose.onclick = closeLightbox;
            lightbox.onclick = (event) => { if (event.target === lightbox) closeLightbox(); };
            lightboxNext.onclick = () => { if (currentImageUrls.length === 0) return; currentImageIndex = (currentImageIndex + 1) % currentImageUrls.length; updateLightboxImage(); };
            lightboxPrev.onclick = () => { if (currentImageUrls.length === 0) return; currentImageIndex = (currentImageIndex - 1 + currentImageUrls.length) % currentImageUrls.length; updateLightboxImage(); };
            lightboxDeleteButton.onclick = () => { confirmModal.classList.add('active'); };
            cancelDeleteButton.onclick = () => { confirmModal.classList.remove('active'); };
            confirmDeleteButton.onclick = () => {
                if (currentImageIndex === -1) return;
                confirmModal.classList.remove('active');
                spinnerOverlay.classList.add('active');
                setTimeout(() => {
                    spinnerOverlay.classList.remove('active');
                    const urlToDelete = currentImageUrls[currentImageIndex];
                    const containerToDelete = document.querySelector(`.pin-container[data-fullsize-url="${urlToDelete}"]`);
                    if (containerToDelete) containerToDelete.remove();
                    currentImageUrls.splice(currentImageIndex, 1);
                    showToast("Imagen eliminada del moodboard");
                    if (currentImageUrls.length === 0) {
                        closeLightbox();
                        parent.postMessage({ pluginMessage: { type: 'back-to-search' } }, '*');
                    } else {
                        currentImageIndex = currentImageIndex % currentImageUrls.length;
                        updateLightboxImage();
                    }
                }, 700);
            };

            const authStep2 = document.getElementById('auth-step-2');
            const connectButton = document.getElementById('connectButton');
            const confirmButton = document.getElementById('confirmButton');
            connectButton.onclick = () => { connectButton.textContent = 'Esperando...'; connectButton.disabled = true; authStep2.style.display = 'flex'; parent.postMessage({ pluginMessage: { type: 'connect-pinterest' } }, '*'); };
            confirmButton.onclick = () => { const token = document.getElementById('tokenInput').value; if (token.trim()) { parent.postMessage({ pluginMessage: { type: 'token-received', token: token.trim() } }, '*'); } };
            
            document.querySelectorAll('.tag').forEach(tag => { tag.onclick = () => { const category = tag.dataset.category; startSearch(category); }; });
            const searchInput = document.getElementById('searchInput');
            const createMoodboardButton = document.getElementById('createMoodboardButton');
            createMoodboardButton.onclick = () => { const category = searchInput.value; startSearch(category); };
            searchInput.onkeydown = (event) => { if (event.key === 'Enter') { const category = searchInput.value; startSearch(category); } };
            document.getElementById('backButton').onclick = () => { parent.postMessage({ pluginMessage: { type: 'back-to-search' } }, '*'); };
        });
    </script>
</body>
</html>